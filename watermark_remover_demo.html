<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Watermark Remover Demo</title>
  <style>
    body{font-family:system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; padding:20px;}
    .row{display:flex;gap:16px;align-items:flex-start}
    .col{flex:1}
    img{max-width:100%;height:auto;border:1px solid #ddd;padding:6px;background:#fff}
    button{padding:8px 12px;margin-top:8px}
    .overlay{position:relative}
    .maskOverlay{position:absolute;left:6px;top:6px;right:6px;bottom:6px;opacity:0.7;pointer-events:none}
    .hint{color:#666;font-size:14px}
  </style>
</head>
<body>
  <h1>Watermark Remover â€” Demo Frontend</h1>
  <p class="hint">This frontend talks to a local backend (see top comments for minimal Flask example). It does not perform heavy processing in the browser.</p>

  <div style="margin-bottom:12px">
    <input id="fileInput" type="file" accept="image/*" />
  </div>

  <div class="row">
    <div class="col">
      <h3>Original</h3>
      <div class="overlay">
        <img id="origPreview" alt="original preview" />
        <canvas id="maskCanvas" class="maskOverlay"></canvas>
      </div>
      <div>
        <button id="detectBtn">Detect Mask</button>
        <button id="downloadMaskBtn">Download Mask</button>
      </div>
    </div>

    <div class="col">
      <h3>Result</h3>
      <img id="resultPreview" alt="result preview" />
      <div>
        <button id="inpaintBtn">Inpaint (server)</button>
        <button id="downloadResultBtn">Download Result</button>
      </div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const origPreview = document.getElementById('origPreview');
    const resultPreview = document.getElementById('resultPreview');
    const detectBtn = document.getElementById('detectBtn');
    const inpaintBtn = document.getElementById('inpaintBtn');
    const maskCanvas = document.getElementById('maskCanvas');
    const downloadMaskBtn = document.getElementById('downloadMaskBtn');
    const downloadResultBtn = document.getElementById('downloadResultBtn');

    let currentFile = null;
    let currentMaskBlob = null;
    let currentResultBlob = null;

    fileInput.addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      currentFile = f;
      origPreview.src = URL.createObjectURL(f);
      origPreview.onload = ()=>{
        maskCanvas.width = origPreview.width;
        maskCanvas.height = origPreview.height;
      }
    });

    async function postFileToEndpoint(endpoint, fileFieldName='image', extraFiles={}){ 
      if(!currentFile) return null;
      const fd = new FormData();
      fd.append(fileFieldName, currentFile, currentFile.name);
      for(const k of Object.keys(extraFiles)){
        fd.append(k, extraFiles[k]);
      }
      const resp = await fetch(endpoint, {method:'POST', body:fd});
      if(!resp.ok) throw new Error('Server error: '+resp.status);
      const blob = await resp.blob();
      return blob;
    }

    detectBtn.addEventListener('click', async ()=>{
      try{
        detectBtn.disabled = true;
        detectBtn.textContent = 'Detecting...';
        const blob = await postFileToEndpoint('/detect-mask');
        currentMaskBlob = blob;
        const img = new Image();
        img.onload = ()=>{
          maskCanvas.width = img.width;
          maskCanvas.height = img.height;
          const ctx = maskCanvas.getContext('2d');
          ctx.clearRect(0,0,maskCanvas.width,maskCanvas.height);
          ctx.globalAlpha = 0.7;
          ctx.drawImage(img, 0, 0);
          ctx.globalCompositeOperation = 'source-atop';
          ctx.fillStyle = 'rgba(255,0,0,0.35)';
          ctx.fillRect(0,0,maskCanvas.width,maskCanvas.height);
          ctx.globalCompositeOperation = 'source-over';
        }
        img.src = URL.createObjectURL(blob);
      }catch(err){
        alert('Detect failed: '+err.message);
      }finally{
        detectBtn.disabled = false;
        detectBtn.textContent = 'Detect Mask';
      }
    });

    inpaintBtn.addEventListener('click', async ()=>{
      try{
        inpaintBtn.disabled = true;
        inpaintBtn.textContent = 'Inpainting...';
        let maskFile = null;
        if(currentMaskBlob){
          maskFile = new File([currentMaskBlob], 'mask.png', {type:currentMaskBlob.type});
        }
        const blob = await postFileToEndpoint('/inpaint', 'image', maskFile?{mask:maskFile}:{})
        currentResultBlob = blob;
        resultPreview.src = URL.createObjectURL(blob);
      }catch(err){
        alert('Inpaint failed: '+err.message);
      }finally{
        inpaintBtn.disabled = false;
        inpaintBtn.textContent = 'Inpaint (server)';
      }
    });

    downloadMaskBtn.addEventListener('click', ()=>{
      if(!currentMaskBlob) return alert('No mask');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(currentMaskBlob);
      a.download = 'mask.png';
      a.click();
    });

    downloadResultBtn.addEventListener('click', ()=>{
      if(!currentResultBlob) return alert('No result');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(currentResultBlob);
      a.download = 'result.png';
      a.click();
    });
  </script>
</body>
</html>
